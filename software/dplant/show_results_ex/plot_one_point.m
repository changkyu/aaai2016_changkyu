%%
clear;
close all;

addpath('../../fadmm1/altmany-export_fig');

data_path = '../../../../../data/result_primdual';
img_path = '../../../../../data/caltech_turntable';

list_method_legend = {'ADMM', 'ADMM-AP', 'ADMM-DAP'};
list_method = {'dppca', 'dppca_ant_Tmax', 'dppca_ant'};

% list_expr = {'ex01_synthetic', 'ex01_synthetic_random', 'ex03_sfm_cube', 'ex08_sfm_caltech', 'ex09_sfm_hopkins'};
list_expr = {'ex01_synthetic_random', 'ex08_sfm_caltech'};
% list_ETA = {'ETA2', 'ETA5', 'ETA10', 'ETA20', 'ETA40'};
list_ETA = {...
    {'ETA10'}, ...
    {'ETA10'} ...
    };
list_NV = {...
    {'NV8', 'NV12', 'NV16', 'NV20', 'NV24'}, ...
    {'NV5'} ...
    };
list_graph = {...
    {'chain', 'cluster1', 'cluster2', 'complete', 'ring', 'star'},...
    {'chain', 'complete', 'ring', 'star'} ...
    };
list_object = {...
    {}, ...
    {'BallSander', 'BoxStuff', 'Rooster', 'Standing', 'StorageBin'}, ...
    {} ...
    };

colorOrder = get(gca, 'ColorOrder');
close gcf;
colorOrder = colorOrder([3 1 2],:);  

sorted_index_synthetic_random = ...
    cell(length(list_ETA{1}), length(list_NV{1}), length(list_graph{1}), length(list_method));
sorted_index_caltech = ...
    cell(length(list_ETA{2}), length(list_NV{2}), length(list_graph{2}), length(list_object{2}), length(list_method));

%% Synthetic Random
i1 = 1;
for i2 = 1 : length(list_ETA{i1})
    for i3 = 1 : length(list_NV{i1})
        for i4 = 1 : length(list_graph{i1})
            h = figure;
            for imt = 1 : length(list_method)
                load(sprintf('%s/%s_%s_%s_%s_%s.mat', ...
                    data_path, ...
                    list_expr{i1}, ...
                    list_method{imt}, ...
                    list_ETA{i1}{i2}, ...
                    list_NV{i1}{i3}, ...
                    list_graph{i1}{i4}));
                
                sorted_index_synthetic_random{i2,i3,i4,imt} = zeros(2,20);

                for i = 1 : 20
                    subplot(4,10,i); 
                    p = semilogy(models{i}.ssaArray);
                    p(1).Color = colorOrder(imt,:);
                    if i == 1 || i == 11
                        ylabel('max subspace angle');
                    end
                    hold on;

                    if length(models{i}.ssaArray) < models{i}.eITER
                        models{i}.eITER = models{i}.eITER - 1;
                    end
                    
                    sorted_index_synthetic_random{i2,i3,i4,imt}(1,i) = models{i}.ssaArray(models{i}.eITER);
                end
                for i = 1 : 20
                    subplot(4,10,i+20); 
                    p = semilogy(models{i}.rmsArray); 
                    p(1).Color = colorOrder(imt,:);
                    if i == 1 || i == 11
                        ylabel('rms');
                    end
                    hold on;

                    sorted_index_synthetic_random{i2,i3,i4,imt}(2,i) = models{i}.rmsArray(models{i}.eITER);
                end
            end
            set(h, 'Position', [0 0 1920 1080]);
            set(gcf, 'Color', 'white');
            
            ha = axes('Position',[0 0 1 1],'Xlim',[0 1],'Ylim',[0 1],...
                'Box','off','Visible','off','Units','normalized', 'clipping' , 'off');
            text(0.5, 1,...
                sprintf('\bf %s / %s / %s / %s', ...
                    list_expr{i1}, ...
                    list_ETA{i1}{i2}, ...
                    list_NV{i1}{i3}, ...
                    list_graph{i1}{i4}), ...
                'HorizontalAlignment','center','VerticalAlignment', 'top');
            
            export_fig( ...
                sprintf('%s_%s_%s_%s.png', ...
                    list_expr{i1}, ...
                    list_ETA{i1}{i2}, ...
                    list_NV{i1}{i3}, ...
                    list_graph{i1}{i4}), ...
                    '-png');
            close gcf;
        end
    end
end

%% Caltech
i1 = 2;
for i2 = 1 : length(list_ETA{i1})
    for i3 = 1 : length(list_NV{i1})
        for i4 = 1 : length(list_graph{i1})
            for i5 = 1 : length(list_object{i1})
                h = figure;
                for imt = 1 : length(list_method)
                    load(sprintf('%s/%s_%s_%s_%s_%s.mat', ...
                        data_path, ...
                        list_expr{i1}, ...
                        list_method{imt}, ...
                        list_ETA{i1}{i2}, ...
                        list_NV{i1}{i3}, ...
                        list_graph{i1}{i4}));
                    
                    sorted_index_caltech{i2,i3,i4,i5,imt} = zeros(2,20);

                    for i = 1 : 20
                        subplot(4,10,i); 
                        p = semilogy(models{i5,1,i}.ssaArray);
                        p(1).Color = colorOrder(imt,:);
                        if i == 1 || i == 11
                            ylabel('max subspace angle');
                        end
                        hold on;
                        
                        if length(models{i5,1,i}.ssaArray) < models{i5,1,i}.eITER
                            models{i5,1,i}.eITER = models{i5,1,i}.eITER - 1;
                        end                        
                        
                        sorted_index_caltech{i2,i3,i4,i5,imt}(1,i) = models{i5,1,i}.ssaArray(models{i5,1,i}.eITER);
                    end
                    for i = 1 : 20
                        subplot(4,10,i+20); 
                        p = semilogy(models{i5,1,i}.rmsArray); 
                        p(1).Color = colorOrder(imt,:);
                        if i == 1 || i == 11
                            ylabel('rms');
                        end
                        hold on;
                        
                        sorted_index_caltech{i2,i3,i4,i5,imt}(2,i) = models{i5,1,i}.rmsArray(models{i5,1,i}.eITER);
                    end
                end
                set(h, 'Position', [0 0 1920 1080]);
                set(gcf, 'Color', 'white');

                ha = axes('Position',[0 0 1 1],'Xlim',[0 1],'Ylim',[0 1],...
                    'Box','off','Visible','off','Units','normalized', 'clipping' , 'off');
                text(0.5, 1,...
                    sprintf('\bf %s / %s / %s / %s / %s', ...
                        list_expr{i1}, ...
                        list_ETA{i1}{i2}, ...
                        list_NV{i1}{i3}, ...
                        list_graph{i1}{i4}, ...
                        list_object{i1}{i5}), ...
                    'HorizontalAlignment','center','VerticalAlignment', 'top');

                export_fig( ...
                    sprintf('%s_%s_%s_%s_%s.png', ...
                        list_expr{i1}, ...
                        list_ETA{i1}{i2}, ...
                        list_NV{i1}{i3}, ...
                        list_graph{i1}{i4}, ...
                        list_object{i1}{i5}), ...
                        '-png');
                close gcf;
            end
        end
    end
end

%% Synthetic Random (sorted)
% i1 = 1;
% for i2 = 1 : length(list_ETA{i1})
%     for i3 = 1 : length(list_NV{i1})
%         for i4 = 1 : length(list_graph{i1})
%             h = figure;
%             min1 = Inf; min2 = Inf; max1 = -Inf; max2 = -Inf;
%             for imt = 1 : length(list_method)
%                 load(sprintf('%s/%s_%s_%s_%s_%s.mat', ...
%                     data_path, ...
%                     list_expr{i1}, ...
%                     list_method{imt}, ...
%                     list_ETA{i1}{i2}, ...
%                     list_NV{i1}{i3}, ...
%                     list_graph{i1}{i4}));
% 
%                 [~, I1] = sort(sorted_index_synthetic_random{i2,i3,i4,imt}(1,:));
%                 [~, I2] = sort(sorted_index_synthetic_random{i2,i3,i4,imt}(2,:));
%                 
%                 for i = 1 : 20
%                     subplot(4,10,i); 
%                     p = semilogy(models{I1(i)}.ssaArray);
%                     p(1).Color = colorOrder(imt,:);
%                     if i == 1 || i == 11
%                         ylabel('max subspace angle');
%                     end
%                     hold on;
%                 end
%                 for i = 1 : 20
%                     subplot(4,10,i+20); 
%                     p = semilogy(models{I2(i)}.rmsArray); 
%                     p(1).Color = colorOrder(imt,:);
%                     if i == 1 || i == 11
%                         ylabel('rms');
%                     end
%                     hold on;
%                 end
%             end
%             set(h, 'Position', [0 0 1920 1080]);
%             set(gcf, 'Color', 'white');
%             
%             ha = axes('Position',[0 0 1 1],'Xlim',[0 1],'Ylim',[0 1],...
%                 'Box','off','Visible','off','Units','normalized', 'clipping' , 'off');
%             text(0.5, 1,...
%                 sprintf('\bf %s / %s / %s / %s', ...
%                     list_expr{i1}, ...
%                     list_ETA{i1}{i2}, ...
%                     list_NV{i1}{i3}, ...
%                     list_graph{i1}{i4}), ...
%                 'HorizontalAlignment','center','VerticalAlignment', 'top');
%             
%             export_fig( ...
%                 sprintf('sorted_%s_%s_%s_%s.png', ...
%                     list_expr{i1}, ...
%                     list_ETA{i1}{i2}, ...
%                     list_NV{i1}{i3}, ...
%                     list_graph{i1}{i4}), ...
%                     '-png');
%             close gcf;
%         end
%     end
% end

%% Caltech (sorted)
i1 = 2;
for i2 = 1 : length(list_ETA{i1})
    for i3 = 1 : length(list_NV{i1})
        for i4 = 1 : length(list_graph{i1})
            for i5 = 1 : length(list_object{i1})
                h = figure;
                min1 = Inf; min2 = Inf; max1 = -Inf; max2 = -Inf;
                for imt = 1 : length(list_method)
                    load(sprintf('%s/%s_%s_%s_%s_%s.mat', ...
                        data_path, ...
                        list_expr{i1}, ...
                        list_method{imt}, ...
                        list_ETA{i1}{i2}, ...
                        list_NV{i1}{i3}, ...
                        list_graph{i1}{i4}));

                    [~, I1] = sort(sorted_index_caltech{i2,i3,i4,i5,imt}(1,:));
                    [~, I2] = sort(sorted_index_caltech{i2,i3,i4,i5,imt}(2,:));

                    for i = 1 : 20
                        subplot(4,10,i); 
                        p = semilogy(models{i5,1,I1(i)}.ssaArray);
                        p(1).Color = colorOrder(imt,:);
                        if i == 1 || i == 11
                            ylabel('max subspace angle');
                        end
                        hold on;
                    end
                    for i = 1 : 20
                        subplot(4,10,i+20); 
                        p = semilogy(models{i5,1,I2(i)}.rmsArray); 
                        p(1).Color = colorOrder(imt,:);
                        if i == 1 || i == 11
                            ylabel('rms');
                        end
                        hold on;
                    end
                end
                set(h, 'Position', [0 0 1920 1080]);
                set(gcf, 'Color', 'white');

                ha = axes('Position',[0 0 1 1],'Xlim',[0 1],'Ylim',[0 1],...
                    'Box','off','Visible','off','Units','normalized', 'clipping' , 'off');
                text(0.5, 1,...
                    sprintf('\bf %s / %s / %s / %s / %s', ...
                        list_expr{i1}, ...
                        list_ETA{i1}{i2}, ...
                        list_NV{i1}{i3}, ...
                        list_graph{i1}{i4}, ...
                        list_object{i1}{i5}), ...
                    'HorizontalAlignment','center','VerticalAlignment', 'top');

                export_fig( ...
                    sprintf('sorted_%s_%s_%s_%s_%s.png', ...
                        list_expr{i1}, ...
                        list_ETA{i1}{i2}, ...
                        list_NV{i1}{i3}, ...
                        list_graph{i1}{i4}, ...
                        list_object{i1}{i5}), ...
                        '-png');
                close gcf;
            end
        end
    end
end
